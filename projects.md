# MaccyScaler — текущее состояние и философия проекта

## Философия
- Рабочая лошадка: максимум качества и скорости без перегруза интерфейса. Пользователь выбирает файл и режим — остальное оптимизировано под капотом.
- Два понятных режима:
  - Быстро: быстрый, стабильно высокий fps, хорошее качество для 90‑х.
  - Качество: больше восстановление и плавность, итоговые 30 fps, разумное время обработки.
- Локально и нативно: задействуем GPU/VideoToolbox/MoltenVK. Никаких «облачных» шагов.
- Надёжные и воспроизводимые инструменты: предпочитаем готовые бинарники ncnn (waifu2x/RealCUGAN/RIFE) и аппаратные энкодеры.
- Прозрачный прогресс: проценты, ETA, детали ошибок. Одна кнопка Старт/Стоп.

## Архитектура (высокоуровнево)
- UI (SwiftUI):
  - Выбор файла → Режим (Быстро/Качество) → Пресет (целевое разрешение).
  - Одна кнопка: Старт/Стоп. Внизу — прогресс/ETA, текущий шаг, время.
- Пайплайн (под капотом):
  1) Извлечение кадров (ffmpeg):
     - Быстро: JPEG (-q:v 2), исходный fps.
     - Качество: PNG без компрессии, fps понижается до 15 (ускорение тяжёлой стадии).
  2) Апскейлинг x2 + денойз:
     - Предпочтение: RealCUGAN → waifu2x → (фолбэк) ESRGAN.
     - Параметры по умолчанию: -s 2 (x2), -n 2 (умеренный денойз), тайлинг -t 384, параллелизм -j 4:4:4, GPU -g 0.
  3) (Только Качество) Интерполяция fps: RIFE до 30 fps.
  4) Сборка видео (ffmpeg):
     - Масштаб до целевого размера (scale=WxH:flags=lanczos).
     - Аппаратный HEVC (hevc_videotoolbox, -tag:v hvc1, -pix_fmt yuv420p), аудио копируется.
- Поиск бинарников:
  - В первую очередь: ~/Documents/Coding/MaccyScaler/bin/ (рекомендуемый путь).
  - Затем: /opt/homebrew/bin и /usr/local/bin.

## Режимы
- Быстро
  - Формат кадров: JPEG.
  - Апскейл: RealCUGAN/waifu2x x2 (с денойзом), затем аппаратный масштаб до пресета.
  - Кодирование: аппаратный HEVC.
  - Применение: массовая обработка, черновой прогон, «быстро и хорошо».
- Качество
  - Формат кадров: PNG, fps 15 для тяжёлой стадии.
  - Апскейл: RealCUGAN/waifu2x x2.
  - Интерполяция: RIFE до 30 fps.
  - Кодирование: аппаратный HEVC.
  - Применение: финальный прогон с лучшей плавностью и деталями.

## Зависимости (исполняемые)
- Обязательные: ffmpeg, ffprobe (обычно /opt/homebrew/bin).
- Рекомендуемые быстрые апскейлеры (ncnn):
  - waifu2x-ncnn-vulkan (macOS arm64 релиз).
  - realcugan-ncnn-vulkan (macOS arm64 релиз).
  - Положить бинарники в ~/Documents/Coding/MaccyScaler/bin/ (или в /opt/homebrew/bin).
- Для интерполяции (Качество): rife-ncnn-vulkan (лежит в rife/rife-ncnn-vulkan).

## Установка быстрых апскейлеров
- Скрипт: scripts/install_fast_upscalers.sh
  - Скачивает и кладёт в bin/ waifu2x (готово). RealCUGAN — вручную, если релиз меняет URL.
- Ручная установка:
  - waifu2x: https://github.com/nihui/waifu2x-ncnn-vulkan/releases (macOS arm64).
  - RealCUGAN: https://github.com/bilibili/Real-CUGAN/releases (macOS arm64).
  - Сделать бинарники исполняемыми и положить в ~/Documents/Coding/MaccyScaler/bin/.

## Прогресс, ETA и отмена
- Прогресс извлечения и сборки: читаем -progress pipe:1 у ffmpeg (out_time_ms).
- Прогресс апскейла: считаем обработанные выходные кадры vs. всего (поллинг каждые 0.5с) + сглаживание ETA.
- FX‑Upscale (если используется): плавная интерполяция между редкими апдейтами.
- Отмена: одна кнопка «Стоп» — убиваем текущий процесс, очищаем временную папку.
- Ошибки: показываем NSAlert с «Подробности» (хвост stderr/stdout), чтобы быстро понять причину.

## Где лежат файлы
- Исходники: Documents/Coding/MaccyScaler/
- Бинарники быстрых апскейлеров: Documents/Coding/MaccyScaler/bin/ (рекомендуется).
- RIFE: Documents/Coding/MaccyScaler/rife/rife-ncnn-vulkan
- Модели ESRGAN: Documents/Coding/MaccyScaler/models/ (только как фолбэк).

## Сборка и запуск
- Обычная сборка и запуск .app:
  - bash scripts/package_app.sh — соберёт Release, упакует MaccyScaler.app, поставит в ~/Applications/ и запустит.
- Очистка старых копий .app:
  - bash scripts/cleanup_old_apps.sh — удалит дубликаты из типичных мест.

## Core ML (план на будущее)
- Цель: ещё выше качество/скорость через Core ML на M‑чипах (ANE/GPU), без Python‑рантайма.
- Базовый пайплайн: FastDVDnet (денойз) → RealBasicVSR‑x2 (временная SR) → (Качество: fps↓/RIFE до 30) → HEVC.
- Файлы:
  - scripts/convert_models_coreml/ — окружение/скрипты конвертации моделей в Core ML, README.
  - Приложение автоматически переключится на Core ML, если найдёт ~/Documents/Coding/MaccyScaler/models-coreml/FastDVDnet.mlmodelc/ и RealBasicVSR_x2.mlmodelc/.
- Статус: каркас и автоподключение готовы, интеграция весов — после подготовки .mlmodelc.

## Приоритеты и компромиссы
- Для видео 90‑х важно: подавить шум/зерно, восстановить детали, сохранить естественность.
- ESRGAN‑x4 слишком тяжёл для стабильных десятков fps локально — используем x2 + аппаратный масштаб и быстрые ncnn‑модели (RealCUGAN/waifu2x).
- В режиме «Качество» самая дорогая стадия идёт на уменьшенном fps, итоговая плавность достигается RIFE.

## Технические заметки
- Параметры ncnn по умолчанию рассчитаны на Apple Silicon; при OOM уменьшить -t до 256/192.
- Съём fps перед апскейлом управляется режимом (избегаем перегруза UI).
- VideoToolbox HEVC уже включён; звук копируется (-c:a copy).

## TL;DR для пользователя
1) Установи быстрые апскейлеры (или просто запусти scripts/install_fast_upscalers.sh).
2) Запусти сборку: bash scripts/package_app.sh.
3) В приложении: брось видео → выбери «Быстро» или «Качество» → «Начать обработку».
4) Следи за прогрессом/ETA; при необходимости жми «Остановить».

***
Если нужно — добавим авто‑бенч одного кадра для автоподбора тайла/параллелизма под твою машину. Также можем прикрутить GFPGAN/CodeFormer для реставрации лиц в Качестве (по детекту и маскам) — по запросу.
